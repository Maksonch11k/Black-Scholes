## 1.1. Пайплайн обработки данных (Data Preprocessing)

Сырые рыночные данные содержат большое количество шума, неликвидных котировок и микроструктурных артефактов. Был реализован многоступенчатый фильтр:

1.  **Call-Options Only (Только Коллы):**
    *   В модель подаются только данные по Call-опционам (`type=2`).

2.  **Фильтрация по времени до экспирации ($T$):**
    *   Исключены опционы, до экспирации которых осталось менее **2.2 дней** ($T < 0.006$).
 
3.  **Фильтрация по Ликвидности и Спредам:**
    *   **Глубина рынка:** Исключены страйки с пустым стаканом (`bid_amount + ask_amount <= 1.0`).
    *   **Контроль спреда:** Исключены котировки, где спред превышает 10% от цены (`(Ask-Bid)/Mid > 0.1`). Широкий спред указывает на неопределенность маркет-мейкера в справедливой цене.

4.  **Sanity Check (Проверка на адекватность):**
    *   Отсекаются выбросы, где подразумеваемая волатильность (IV) выходит за пределы диапазона [1% ... 300%].

## 1.4. Математическая модель

Для построения поверхности используется метод сглаживающих сплайнов в пространстве общей дисперсии.

### Шаг 1: Расчет сырой волатильности (Raw IV)
Для каждого валидного страйка $K$ решается обратная задача Блэка-Шоулза для нахождения $\sigma_{implied}$:

$$ C_{market} = S \cdot N(d_1) - K \cdot e^{-rT} \cdot N(d_2) $$

Где $r=0$ . Решение находится численным методом Брента.

### Шаг 2: Трансформация координат
Интерполяция волатильности напрямую ($\sigma$ vs $K$) нестабильна. Мы используем пространство, где "улыбка" имеет форму, близкую к параболе:

*   **Ось X (Log-Moneyness):**
    $$ x = \ln\left(\frac{K}{F}\right) $$
    Где $F$ — форвардная цена (в нашем случае $F \approx S$). Это центрирует улыбку вокруг нуля.

*   **Ось Y (Общая дисперсия):**
    $$ w(x) = \sigma_{implied}^2 \cdot T $$
    Это позволяет линеаризовать временной распад.

### Шаг 3: Сглаживающий Сплайн (Smoothing Spline)
Мы аппроксимируем зависимость $w(x)$ с помощью **Кубического сплайна** ($k=3$).
Вместо жесткой интерполяции (прохождения через каждую точку) используется задача минимизации с регуляризацией:

$$ \min \left( \sum w_i (y_i - g(x_i))^2 + \lambda \int [g''(x)]^2 dx \right) $$

*   **Веса ($w_i$):** Обратно пропорциональны спреду. Точки с узким спредом "притягивают" линию сильнее.
*   **Параметр сглаживания ($\lambda$, smoothing_factor):** Установлен на уровне **25.0**.
    *   Это значение было найдено подбором. Оно обеспечивает оптимальный баланс: убирает микроструктурный шум и арбитраж, но сохраняет форму рыночной улыбки.

### Шаг 4: Валидация (Безарбитражность)
Полученная кривая проверяется на отсутствие статического арбитража =. Для этого численно вычисляется плотность вероятности (Risk-Neutral PDF):

$$ PDF(K) = e^{rT} \frac{\partial^2 C}{\partial K^2} $$

Условие корректности модели: $PDF(K) \ge 0$ для всех страйков.

---

## 2. Результаты тестирования

### Тест №1: Точность оценки (Pricing Accuracy)
**Методика:** Тест "Out-of-Sample". В каждый из 165 дней мы случайно скрывали **20%** реальных сделок, обучали модель на остальных 80%, а затем проверяли, насколько точно модель предсказывает волатильность скрытых опционов.

**Итоговые показатели:**
| Метрика | Значение | Оценка |
| :--- | :--- | :--- |
| **RMSE IV (Ошибка волатильности)** | **2.65%** 
| **Процент дней с арбитражем** | **3.0%** 

**Анализ результатов:**
*   В 97% дней модель строит математически корректную (безарбитражную) поверхность.
*   **Выбросы:** Наблюдались редкие всплески ошибки (например, `2024-11-20` ошибка 29%, `2024-12-16` ошибка 26%). Это связано с шоковыми событиями на рынке, когда стакан становится пустым и спреды расширяются до 50%+.

---

### Тест №2: Торговля волатильностью (P&L Backtest)
**Методика:** Симуляция торговой стратегии **Volatility Arbitrage**.
*   Модель ищет расхождения: если рыночная волатильность отличается от модельной более чем на **2%**, совершается сделка (покупка недооцененного / продажа переоцененного опциона).
*   Позиция удерживается 1 сутки.

**Результаты:**
*   **Итоговая прибыль (Net P&L):** **+$289.13**
*   **Характер доходности:**
    *   В периоды низкой волатильности стратегия работает "в ноль" или небольшой минус из-за спредов.
    *   Основная прибыль получена во время **рыночных аномалий** (например, март 2025), когда паника заставляла участников рынка совершать сделки по неэффективным ценам